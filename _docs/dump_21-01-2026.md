## rds-ai-engine.php

```php
<?php

/**
 * Plugin Name: RDS AI Engine
 * Plugin URI: https://github.com/your-username/rds-ai-engine
 * Description: Базовый плагин для интеграции с ИИ в WordPress. Предоставляет управление моделями, ассистентами, базой знаний и историей диалогов.
 * Version: 1.0.0
 * Author: Your Name
 * License: GPL v2 or later
 * Text Domain: rds-ai-engine
 * Domain Path: /languages
 * Requires at least: 5.6
 * Requires PHP: 7.4
 */

// Если файл вызывается напрямую, прерываем выполнение
if (!defined('ABSPATH')) {
	exit;
}

// Константы плагина
define('RDS_AIE_VERSION', '1.0.0');
define('RDS_AIE_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('RDS_AIE_PLUGIN_URL', plugin_dir_url(__FILE__));
define('RDS_AIE_PLUGIN_BASENAME', plugin_basename(__FILE__));

// Константы для типовых ассистентов
define('RDS_AIE_ASSISTANT_GENERAL', 0);
define('RDS_AIE_ASSISTANT_CREATIVE', 1);
define('RDS_AIE_ASSISTANT_TECHNICAL', 2);
define('RDS_AIE_ASSISTANT_SUPPORT', 3);

// Вспомогательные функции
if (!function_exists('rds_aie_create_assistant')) {
	function rds_aie_create_assistant($name, $system_prompt, $args = [])
	{
		$ai_engine = RDS_AIE_Main::get_instance();
		return $ai_engine->create_assistant(array_merge([
			'name' => $name,
			'system_prompt' => $system_prompt
		], $args));
	}
}

if (!function_exists('rds_aie_get_assistant')) {
	function rds_aie_get_assistant($assistant_id)
	{
		$ai_engine = RDS_AIE_Main::get_instance();
		return $ai_engine->get_assistant($assistant_id);
	}
}

if (!function_exists('rds_aie_chat')) {
	function rds_aie_chat($message, $assistant_id = 0, $args = [])
	{
		$ai_engine = RDS_AIE_Main::get_instance();
		return $ai_engine->chat_completion(array_merge([
			'assistant_id' => $assistant_id,
			'message' => $message
		], $args));
	}
}

// Простой автозагрузчик классов
function rds_aie_autoloader($class_name)
{
	// Наш префикс
	$prefix = 'RDS_AIE_';

	// Проверяем, относится ли класс к нашему плагину
	$len = strlen($prefix);
	if (strncmp($prefix, $class_name, $len) !== 0) {
		return;
	}

	// Получаем относительное имя класса
	$relative_class = substr($class_name, $len);

	// Формируем путь к файлу
	$file = RDS_AIE_PLUGIN_DIR . 'includes/class-' . strtolower(str_replace('_', '-', $relative_class)) . '.php';

	// Если файл существует, подключаем его
	if (file_exists($file)) {
		require_once $file;
	} else {
		// Для отладки
		error_log("RDS AI Engine: Class file not found: $file for class $class_name");
	}
}

// Регистрируем автозагрузчик
spl_autoload_register('rds_aie_autoloader');

// Проверяем, что все основные классы загружены
function rds_aie_check_classes()
{
	$required_classes = [
		'RDS_AIE_Main',
		'RDS_AIE_DB',
		'RDS_AIE_Model_Manager',
		'RDS_AIE_Assistant_Manager',
		'RDS_AIE_AI_Client'
	];

	foreach ($required_classes as $class) {
		if (!class_exists($class)) {
			error_log("RDS AI Engine: Required class $class not found");
			return false;
		}
	}
	return true;
}

// Инициализация плагина
function rds_aie_init()
{
	// Проверяем наличие классов
	if (!rds_aie_check_classes()) {
		add_action('admin_notices', function () {
?>
			<div class="notice notice-error">
				<p><strong>RDS AI Engine:</strong> Не удалось загрузить необходимые классы. Проверьте наличие файлов в папке includes/.</p>
			</div>
<?php
		});
		return;
	}

	// Загрузка текстового домена
	load_plugin_textdomain('rds-ai-engine', false, dirname(RDS_AIE_PLUGIN_BASENAME) . '/languages');

	// Инициализация главного класса
	$GLOBALS['rds_aie'] = RDS_AIE_Main::get_instance();
}
add_action('plugins_loaded', 'rds_aie_init');

// Хуки активации и деактивации
register_activation_hook(__FILE__, 'rds_aie_activate_plugin');
register_deactivation_hook(__FILE__, 'rds_aie_deactivate_plugin');

function rds_aie_activate_plugin()
{
	// Сначала загружаем класс DB
	rds_aie_autoloader('RDS_AIE_DB');

	if (class_exists('RDS_AIE_DB')) {
		$db = new RDS_AIE_DB();
		$db->create_tables();

		// Добавляем опции по умолчанию
		add_option('rds_aie_version', RDS_AIE_VERSION);
		add_option('rds_aie_default_settings', [
			'max_tokens' => 1000,
			'temperature' => 0.7,
			'history_enabled' => true,
			'history_messages_count' => 10
		]);
	}
}

function rds_aie_deactivate_plugin()
{
	// Очистка кеша, остановка крона и т.д.
	wp_clear_scheduled_hook('rds_aie_cleanup_history');
}

// Хук для удаления плагина
register_uninstall_hook(__FILE__, 'rds_aie_uninstall_plugin');

function rds_aie_uninstall_plugin()
{
	// Загружаем класс DB
	rds_aie_autoloader('RDS_AIE_DB');

	if (class_exists('RDS_AIE_DB')) {
		// Удаление таблиц БД
		$db = new RDS_AIE_DB();
		$db->drop_tables();
	}

	// Удаление опций
	delete_option('rds_aie_version');
	delete_option('rds_aie_default_settings');
}

```

## admin/css/admin.css

```css
/* Основные стили для RDS AI Engine */

.rds-aie-admin {
  max-width: 1200px;
}

.rds-aie-admin .nav-tab-wrapper {
  margin-bottom: 20px;
}

/* Формы */
.rds-aie-admin .form-table th {
  width: 200px;
}

/* Списки */
.rds-aie-admin .wp-list-table {
  margin-top: 20px;
}

.rds-aie-admin .button-link-delete {
  color: #dc3232;
  border-color: #dc3232;
}

.rds-aie-admin .button-link-delete:hover {
  background: #dc3232;
  color: white;
}

/* Подтверждение удаления */
.rds-aie-admin .confirm-delete {
  background: #fff;
  border: 1px solid #ccd0d4;
  border-left: 4px solid #dc3232;
  padding: 15px;
  margin-bottom: 20px;
}

/* Чат */
.rds-aie-chat .chat-container {
  background: #fff;
  border: 1px solid #ccd0d4;
  border-radius: 4px;
  overflow: hidden;
}

.rds-aie-chat .chat-controls {
  padding: 20px;
  background: #f7f7f7;
  border-bottom: 1px solid #ddd;
}

.rds-aie-chat .chat-messages {
  height: 400px;
  overflow-y: auto;
  padding: 20px;
}

.rds-aie-chat .chat-welcome {
  text-align: center;
  color: #666;
  padding: 40px 20px;
}

.rds-aie-chat .message {
  margin-bottom: 15px;
  padding: 10px 15px;
  border-radius: 4px;
  max-width: 80%;
}

.rds-aie-chat .message.user {
  background: #e3f2fd;
  margin-left: auto;
  border: 1px solid #bbdefb;
}

.rds-aie-chat .message.assistant {
  background: #f5f5f5;
  margin-right: auto;
  border: 1px solid #e0e0e0;
}

.rds-aie-chat .message.error {
  background: #ffebee;
  border-color: #ffcdd2;
  color: #c62828;
  max-width: 100%;
}

.rds-aie-chat .message .sender {
  font-weight: bold;
  font-size: 0.9em;
  margin-bottom: 5px;
  color: #666;
}

.rds-aie-chat .message .content {
  line-height: 1.5;
}

.rds-aie-chat .message .time {
  font-size: 0.8em;
  color: #999;
  text-align: right;
  margin-top: 5px;
}

.rds-aie-chat .chat-input {
  padding: 20px;
  border-top: 1px solid #ddd;
  background: #f7f7f7;
}

.rds-aie-chat .chat-input textarea {
  width: 100%;
  resize: vertical;
  margin-bottom: 10px;
}

.rds-aie-chat .chat-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* Индикатор загрузки */
.rds-aie-chat .loading {
  text-align: center;
  padding: 10px;
  color: #666;
}

.rds-aie-chat .loading:before {
  content: "";
  display: inline-block;
  width: 16px;
  height: 16px;
  margin-right: 8px;
  vertical-align: middle;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* Адаптивность */
@media screen and (max-width: 782px) {
  .rds-aie-chat .chat-controls .form-table th,
  .rds-aie-chat .chat-controls .form-table td {
    display: block;
    width: 100%;
  }

  .rds-aie-chat .chat-controls .form-table th {
    padding-bottom: 5px;
  }

  .rds-aie-chat .message {
    max-width: 95%;
  }
}

/* Отладка */
.debug-container {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 20px;
  padding: 0;
}

.debug-container h3 {
  margin: 0;
  padding: 15px 20px;
  background: #e9ecef;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
}

.debug-tabs {
  display: flex;
  border-bottom: 1px solid #ddd;
  background: #f1f3f4;
}

.debug-tab {
  padding: 10px 20px;
  background: none;
  border: none;
  border-right: 1px solid #ddd;
  cursor: pointer;
  font-size: 13px;
  color: #666;
  transition: all 0.2s;
}

.debug-tab:hover {
  background: #e9ecef;
}

.debug-tab.active {
  background: #fff;
  color: #2271b1;
  font-weight: 600;
}

.debug-content {
  padding: 15px;
  max-height: 300px;
  overflow-y: auto;
}

.debug-tab-content {
  display: none;
}

.debug-tab-content.active {
  display: block;
}

.debug-tab-content pre {
  margin: 0;
  padding: 10px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 3px;
  font-size: 12px;
  line-height: 1.4;
  max-height: 250px;
  overflow-y: auto;
}

.debug-tab-content code {
  font-family: "Courier New", Courier, monospace;
  white-space: pre-wrap;
  word-break: break-all;
}
```

## admin/js/chat.js

```js
(function ($) {
  "use strict";

  // Хранение истории сообщений
  let chatHistory = [];
  let currentSessionId = "";
  let debugData = {
    lastRequest: null,
    lastResponse: null,
    lastHistory: null,
  };

  // Инициализация
  $(document).ready(function () {
    // Генерируем session_id для чата
    currentSessionId =
      "chat_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

    // Активация кнопки отправки при вводе текста
    $("#chatInput").on("input", function () {
      const hasText = $(this).val().trim().length > 0;
      $("#sendMessage").prop("disabled", !hasText);
    });

    // Отправка сообщения по клику
    $("#sendMessage").on("click", sendMessage);

    // Отправка сообщения по Enter (без Shift)
    $("#chatInput").on("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!$("#sendMessage").prop("disabled")) {
          sendMessage();
        }
      }
    });

    // Очистка чата
    $("#clearChat").on("click", clearChat);

    // Переключение отладки
    $("#toggleDebug").on("click", toggleDebug);

    // Переключение вкладок отладки
    $(".debug-tab").on("click", function () {
      const tab = $(this).data("tab");
      switchDebugTab(tab);
    });

    // Автофокус на поле ввода
    $("#chatInput").focus();
  });

  /**
   * Отправка сообщения
   */
  function sendMessage() {
    const message = $("#chatInput").val().trim();
    const modelId = $("#chat_model").val();
    const assistantId = $("#chat_assistant").val();

    if (!message) {
      return;
    }

    // Проверка выбора модели или ассистента
    if (!modelId && !assistantId) {
      alert(
        rds_aie_ajax.select_model_or_assistant ||
          "Please select a model or assistant.",
      );
      return;
    }

    // Добавление сообщения пользователя в чат
    addMessage("user", message);

    // Очистка поля ввода
    $("#chatInput").val("");
    $("#sendMessage").prop("disabled", true);

    // Показ индикатора загрузки
    showLoading();

    // Сохраняем данные для отладки
    debugData.lastRequest = {
      message: message,
      model_id: modelId,
      assistant_id: assistantId,
      session_id: currentSessionId,
      timestamp: new Date().toISOString(),
    };

    // Показываем данные запроса в отладке
    updateDebugInfo();

    // Отправка запроса на сервер с session_id
    $.ajax({
      url: rds_aie_ajax.ajax_url,
      type: "POST",
      data: {
        action: "rds_aie_test_chat",
        nonce: rds_aie_ajax.nonce,
        message: message,
        model_id: modelId,
        assistant_id: assistantId,
        session_id: currentSessionId,
        debug: 1,
      },
      success: function (response) {
        hideLoading();

        if (response.success) {
          addMessage("assistant", response.data.response);

          // Сохраняем данные ответа для отладки
          debugData.lastResponse = {
            raw: response,
            content: response.data.response,
            timestamp: new Date().toISOString(),
          };

          // Если пришел отладочный ответ
          if (response.data.debug) {
            debugData.lastHistory = response.data.debug.database_history;
            debugData.lastRequest = response.data.debug.messages_to_ai;
            debugData.fullRequest = response.data.debug.full_request_json;
            debugData.lastResponse.raw_api = response.data.debug.api_response;
            // console.log("response.data.debug isset", response.data.debug);
          } else {
            // console.log("response.data.debug not found", response.data.debug);
          }
        } else {
          addMessage("error", response.data.message || rds_aie_ajax.error_text);

          debugData.lastResponse = {
            error: response.data.message || rds_aie_ajax.error_text,
            timestamp: new Date().toISOString(),
          };
        }

        // Обновляем информацию отладки
        updateDebugInfo();

        // Прокрутка к последнему сообщению
        scrollToBottom();
      },
      error: function (xhr, status, error) {
        hideLoading();
        addMessage("error", rds_aie_ajax.error_text);

        debugData.lastResponse = {
          error: error,
          status: status,
          xhr: xhr,
          timestamp: new Date().toISOString(),
        };

        updateDebugInfo();
        scrollToBottom();
      },
    });
  }

  /**
   * Обновление информации отладки
   */
  function updateDebugInfo() {
    if (!$("#debugContainer").is(":visible")) {
      return;
    }

    // console.log("lastRequest", debugData.lastRequest);
    // console.log("lastHistory", debugData.lastHistory);
    // console.log("lastResponse", debugData.lastResponse);

    // Обновляем вкладку запроса
    if (debugData.lastRequest) {
      $("#debugRequestContent").text(
        JSON.stringify(debugData.lastRequest, null, 2),
      );
    }

    // Обновляем вкладку истории
    if (debugData.lastHistory) {
      $("#debugHistoryContent").text(
        JSON.stringify(debugData.lastHistory, null, 2),
      );
    } else {
      $("#debugHistoryContent").text(
        rds_aie_ajax.no_history || "No conversation history retrieved.",
      );
    }

    // Обновляем вкладку полного запроса
    if (debugData.lastRequest) {
      $("#debugFullrequestContent").text(
        JSON.stringify(debugData.fullRequest, null, 2),
      );
    }

    // Обновляем вкладку ответа
    if (debugData.lastResponse) {
      $("#debugResponseContent").text(
        JSON.stringify(debugData.lastResponse, null, 2),
      );
    }
  }

  /**
   * Переключение вкладок отладки
   */
  function switchDebugTab(tab) {
    // Убираем активный класс со всех вкладок
    $(".debug-tab").removeClass("active");
    $(".debug-tab-content").removeClass("active");

    // Добавляем активный класс выбранной вкладке и контенту
    $(`.debug-tab[data-tab="${tab}"]`).addClass("active");
    $(`#debug${tab.charAt(0).toUpperCase() + tab.slice(1)}`).addClass("active");
  }

  /**
   * Переключение отладки
   */
  function toggleDebug() {
    const debugContainer = $("#debugContainer");
    const isVisible = debugContainer.is(":visible");

    if (isVisible) {
      debugContainer.hide();
      $("#toggleDebug").text(rds_aie_ajax.show_debug || "Show Debug");
    } else {
      debugContainer.show();
      $("#toggleDebug").text(rds_aie_ajax.hide_debug || "Hide Debug");

      // Обновляем информацию, если есть данные
      updateDebugInfo();
    }
  }

  /**
   * Добавление сообщения в чат
   */
  function addMessage(type, content) {
    const messagesContainer = $("#chatMessages");
    const timestamp = new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });

    // Определение отправителя и класса
    let sender, cssClass;
    switch (type) {
      case "user":
        sender = "You";
        cssClass = "user";
        break;
      case "assistant":
        sender = "Assistant";
        cssClass = "assistant";
        break;
      case "error":
        sender = "Error";
        cssClass = "error";
        break;
      default:
        sender = "Unknown";
        cssClass = "assistant";
    }

    // Создание HTML сообщения
    const messageHtml = `
            <div class="message ${cssClass}">
                <div class="sender">${sender}</div>
                <div class="content">${escapeHtml(content)}</div>
                <div class="time">${timestamp}</div>
            </div>
        `;

    // Добавление сообщения
    messagesContainer.append(messageHtml);

    // Удаление приветственного сообщения, если оно есть
    $(".chat-welcome").remove();

    // Сохранение в историю
    chatHistory.push({ type, content, timestamp });

    // Прокрутка к последнему сообщению
    scrollToBottom();
  }

  /**
   * Показать индикатор загрузки
   */
  function showLoading() {
    const messagesContainer = $("#chatMessages");
    messagesContainer.append(
      '<div class="loading">' + rds_aie_ajax.loading_text + "</div>",
    );
    scrollToBottom();
  }

  /**
   * Скрыть индикатор загрузки
   */
  function hideLoading() {
    $(".loading").remove();
  }

  /**
   * Очистка чата
   */
  function clearChat() {
    if (
      confirm(
        rds_aie_ajax.confirm_clear ||
          "Are you sure you want to clear the chat?",
      )
    ) {
      // Генерируем новый session_id
      currentSessionId =
        "chat_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

      $("#chatMessages").html(
        '<div class="chat-welcome"><p>' +
          (rds_aie_ajax.chat_welcome ||
            "Start a conversation by typing a message below.") +
          "</p></div>",
      );
      chatHistory = [];
      debugData = { lastRequest: null, lastResponse: null, lastHistory: null };

      // Очищаем отладку
      $("#debugRequestContent").text(
        rds_aie_ajax.no_request || "No request data yet...",
      );
      $("#debugHistoryContent").text(
        rds_aie_ajax.no_history || "No history data yet...",
      );
      $("#debugResponseContent").text(
        rds_aie_ajax.no_response || "No response data yet...",
      );

      scrollToBottom();
    }
  }

  /**
   * Прокрутка к последнему сообщению
   */
  function scrollToBottom() {
    const messagesContainer = $("#chatMessages");
    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
  }

  /**
   * Экранирование HTML
   */
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, "<br>");
  }
})(jQuery);
```

## admin/views/admin-page.php

```php
<?php

/**
 * Шаблон главной страницы админки плагина
 */

// Получение текущей вкладки
$current_tab = isset($_GET['tab']) ? sanitize_key($_GET['tab']) : 'models';

// Названия вкладок
$tabs = [
	'models' => __('Models', 'rds-ai-engine'),
	'assistants' => __('Assistants', 'rds-ai-engine'),
	'history' => __('History', 'rds-ai-engine'),
	'chat' => __('Test Chat', 'rds-ai-engine')
];
?>
<div class="wrap rds-aie-admin">
	<h1><?php echo esc_html(get_admin_page_title()); ?></h1>

	<nav class="nav-tab-wrapper">
		<?php foreach ($tabs as $tab_key => $tab_name): ?>
			<a href="<?php echo admin_url('admin.php?page=rds-aie&tab=' . esc_attr($tab_key)); ?>"
				class="nav-tab <?php echo $current_tab === $tab_key ? 'nav-tab-active' : ''; ?>">
				<?php echo esc_html($tab_name); ?>
			</a>
		<?php endforeach; ?>
	</nav>

	<div class="tab-content">
		<?php
		// Подключаем контент вкладки
		$tab_file = RDS_AIE_PLUGIN_DIR . 'admin/views/tab-' . $current_tab . '.php';
		if (file_exists($tab_file)) {
			include $tab_file;
		} else {
			echo '<p>' . __('Tab content not found.', 'rds-ai-engine') . '</p>';
		}
		?>
	</div>
</div>
```

## admin/views/tab-assistants.php

```php
<?php

/**
 * Вкладка управления ассистентами
 */

// Получаем экземпляр плагина
$main = RDS_AIE_Main::get_instance();
$model_manager = $main->get_model_manager();
$assistant_manager = $main->get_assistant_manager();

// Проверяем, что менеджер инициализирован
if (!$model_manager) {
	echo '<div class="notice notice-error"><p>' .
		__('Model manager is not initialized.', 'rds-ai-engine') .
		'</p></div>';
	return;
}

$models = $model_manager->get_all();
$assistants = $assistant_manager->get_all();

// Обработка действий
if (isset($_POST['action'])) {
	$action = sanitize_key($_POST['action']);
	$nonce = isset($_POST['_wpnonce']) ? $_POST['_wpnonce'] : '';

	if (wp_verify_nonce($nonce, 'rds_aie_assistants')) {
		try {
			switch ($action) {
				case 'save_assistant':
					$assistant_data = [
						'id' => isset($_POST['assistant_id']) ? intval($_POST['assistant_id']) : 0,
						'name' => sanitize_text_field($_POST['name']),
						'system_prompt' => sanitize_textarea_field($_POST['system_prompt']),
						'default_model_id' => !empty($_POST['default_model_id']) ? intval($_POST['default_model_id']) : null,
						'max_tokens' => intval($_POST['max_tokens']),
						'temperature' => floatval($_POST['temperature']),
						'history_enabled' => isset($_POST['history_enabled']) ? 1 : 0,
						'history_messages_count' => intval($_POST['history_messages_count']),
						'knowledge_base_enabled' => isset($_POST['knowledge_base_enabled']) ? 1 : 0
					];

					$assistant_manager->save($assistant_data);
					echo '<div class="notice notice-success"><p>' .
						__('Assistant saved successfully.', 'rds-ai-engine') .
						'</p></div>';
					break;

				case 'delete_assistant':
					$assistant_id = intval($_POST['assistant_id']);
					$assistant_manager->delete($assistant_id);
					echo '<div class="notice notice-success"><p>' .
						__('Assistant deleted successfully.', 'rds-ai-engine') .
						'</p></div>';
					break;
			}

			// Обновляем список ассистентов
			$assistants = $assistant_manager->get_all();
		} catch (Exception $e) {
			echo '<div class="notice notice-error"><p>' .
				esc_html($e->getMessage()) .
				'</p></div>';
		}
	}
}

// Получение данных ассистента для редактирования
$edit_assistant = null;
if (isset($_GET['edit'])) {
	$edit_assistant = $assistant_manager->get(intval($_GET['edit']));
}

// Получение ассистента для удаления
$delete_assistant = null;
if (isset($_GET['delete'])) {
	$delete_assistant = $assistant_manager->get(intval($_GET['delete']));
}
?>

<div class="rds-aie-assistants">
	<?php if ($delete_assistant): ?>
		<!-- Форма подтверждения удаления -->
		<div class="confirm-delete">
			<h2><?php _e('Confirm Delete', 'rds-ai-engine'); ?></h2>
			<p><?php printf(
					__('Are you sure you want to delete assistant "%s"?', 'rds-ai-engine'),
					esc_html($delete_assistant->name)
				); ?></p>
			<form method="post">
				<?php wp_nonce_field('rds_aie_assistants'); ?>
				<input type="hidden" name="action" value="delete_assistant">
				<input type="hidden" name="assistant_id" value="<?php echo esc_attr($delete_assistant->id); ?>">
				<button type="submit" class="button button-danger"><?php _e('Delete', 'rds-ai-engine'); ?></button>
				<a href="?page=rds-aie&tab=assistants" class="button"><?php _e('Cancel', 'rds-ai-engine'); ?></a>
			</form>
		</div>
	<?php endif; ?>

	<!-- Форма добавления/редактирования ассистента -->
	<div class="assistant-form">
		<h2><?php echo $edit_assistant ? __('Edit Assistant', 'rds-ai-engine') : __('Add New Assistant', 'rds-ai-engine'); ?></h2>
		<form method="post">
			<?php wp_nonce_field('rds_aie_assistants'); ?>
			<input type="hidden" name="action" value="save_assistant">
			<input type="hidden" name="assistant_id" value="<?php echo $edit_assistant ? esc_attr($edit_assistant->id) : 0; ?>">

			<table class="form-table">
				<tr>
					<th scope="row">
						<label for="name"><?php _e('Assistant Name', 'rds-ai-engine'); ?> *</label>
					</th>
					<td>
						<input type="text" id="name" name="name" class="regular-text"
							value="<?php echo $edit_assistant ? esc_attr($edit_assistant->name) : ''; ?>" required>
						<p class="description"><?php _e('A descriptive name for this assistant.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="system_prompt"><?php _e('System Prompt', 'rds-ai-engine'); ?> *</label>
					</th>
					<td>
						<textarea id="system_prompt" name="system_prompt" rows="5" class="large-text" required><?php
																												echo $edit_assistant ? esc_textarea($edit_assistant->system_prompt) : '';
																												?></textarea>
						<p class="description"><?php _e('Instructions that define the assistant\'s behavior and personality.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="default_model_id"><?php _e('Default Model', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<select id="default_model_id" name="default_model_id" class="regular-text">
							<option value=""><?php _e('-- Select Model --', 'rds-ai-engine'); ?></option>
							<?php foreach ($models as $model): ?>
								<option value="<?php echo esc_attr($model->id); ?>"
									<?php selected($edit_assistant ? $edit_assistant->default_model_id : 0, $model->id); ?>>
									<?php echo esc_html($model->name); ?>
								</option>
							<?php endforeach; ?>
						</select>
						<p class="description"><?php _e('Default AI model for this assistant.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="max_tokens"><?php _e('Max Response Tokens', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<input type="number" id="max_tokens" name="max_tokens" min="1" max="32000" step="1"
							value="<?php echo $edit_assistant ? esc_attr($edit_assistant->max_tokens) : 1000; ?>">
						<p class="description"><?php _e('Maximum tokens in the assistant\'s response.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="temperature"><?php _e('Temperature', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<input type="number" id="temperature" name="temperature" min="0" max="2" step="0.1"
							value="<?php echo $edit_assistant ? esc_attr($edit_assistant->temperature) : 0.7; ?>">
						<p class="description"><?php _e('Controls randomness: lower = more focused, higher = more creative.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="history_enabled"><?php _e('Enable History', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<label>
							<input type="checkbox" id="history_enabled" name="history_enabled" value="1"
								<?php checked($edit_assistant ? $edit_assistant->history_enabled : 1); ?>>
							<?php _e('Keep conversation history', 'rds-ai-engine'); ?>
						</label>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="history_messages_count"><?php _e('History Messages Count', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<input type="number" id="history_messages_count" name="history_messages_count" min="1" max="100" step="1"
							value="<?php echo $edit_assistant ? esc_attr($edit_assistant->history_messages_count) : 10; ?>">
						<p class="description"><?php _e('Number of previous messages to include in context.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="knowledge_base_enabled"><?php _e('Enable Knowledge Base', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<label>
							<input type="checkbox" id="knowledge_base_enabled" name="knowledge_base_enabled" value="1"
								<?php checked($edit_assistant ? $edit_assistant->knowledge_base_enabled : 0); ?>>
							<?php _e('Use knowledge base for responses', 'rds-ai-engine'); ?>
						</label>
						<p class="description"><?php _e('(Feature will be available in the next update)', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
			</table>

			<p class="submit">
				<button type="submit" class="button button-primary">
					<?php echo $edit_assistant ? __('Update Assistant', 'rds-ai-engine') : __('Add Assistant', 'rds-ai-engine'); ?>
				</button>
				<?php if ($edit_assistant): ?>
					<a href="?page=rds-aie&tab=assistants" class="button"><?php _e('Cancel', 'rds-ai-engine'); ?></a>
				<?php endif; ?>
			</p>
		</form>
	</div>

	<!-- Список ассистентов -->
	<div class="assistants-list">
		<h2><?php _e('Available Assistants', 'rds-ai-engine'); ?></h2>

		<?php if (empty($assistants)): ?>
			<p><?php _e('No assistants created yet.', 'rds-ai-engine'); ?></p>
		<?php else: ?>
			<table class="wp-list-table widefat fixed striped">
				<thead>
					<tr>
						<th><?php _e('Name', 'rds-ai-engine'); ?></th>
						<th><?php _e('Default Model', 'rds-ai-engine'); ?></th>
						<th><?php _e('Max Tokens', 'rds-ai-engine'); ?></th>
						<th><?php _e('Temperature', 'rds-ai-engine'); ?></th>
						<th><?php _e('History', 'rds-ai-engine'); ?></th>
						<th><?php _e('Actions', 'rds-ai-engine'); ?></th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($assistants as $assistant): ?>
						<tr>
							<td><?php echo esc_html($assistant->name); ?></td>
							<td><?php echo esc_html($assistant->model_name ?: '—'); ?></td>
							<td><?php echo esc_html($assistant->max_tokens); ?></td>
							<td><?php echo esc_html($assistant->temperature); ?></td>
							<td>
								<?php if ($assistant->history_enabled): ?>
									<span class="dashicons dashicons-yes" style="color: #46b450;"></span>
									(<?php echo esc_html($assistant->history_messages_count); ?>)
								<?php else: ?>
									<span class="dashicons dashicons-no" style="color: #dc3232;"></span>
								<?php endif; ?>
							</td>
							<td>
								<a href="?page=rds-aie&tab=assistants&edit=<?php echo esc_attr($assistant->id); ?>"
									class="button button-small">
									<?php _e('Edit', 'rds-ai-engine'); ?>
								</a>
								<a href="?page=rds-aie&tab=assistants&delete=<?php echo esc_attr($assistant->id); ?>"
									class="button button-small button-link-delete">
									<?php _e('Delete', 'rds-ai-engine'); ?>
								</a>
							</td>
						</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		<?php endif; ?>
	</div>
</div>
```

## admin/views/tab-chat.php

```php
<?php

/**
 * Вкладка тестового чата
 */

$main = RDS_AIE_Main::get_instance();
$model_manager = $main->get_model_manager();
$assistant_manager = $main->get_assistant_manager();

$models = $model_manager->get_all();
$assistants = $assistant_manager->get_all();
?>

<div class="rds-aie-chat">
	<h2><?php _e('Test Chat', 'rds-ai-engine'); ?></h2>
	<p class="description"><?php _e('Test your AI models and assistants in real-time.', 'rds-ai-engine'); ?></p>

	<div class="chat-container">
		<div class="chat-controls">
			<table class="form-table">
				<tr>
					<th scope="row">
						<label for="chat_model"><?php _e('AI Model', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<select id="chat_model" class="regular-text">
							<option value=""><?php _e('-- Select Model --', 'rds-ai-engine'); ?></option>
							<?php foreach ($models as $model): ?>
								<option value="<?php echo esc_attr($model->id); ?>">
									<?php echo esc_html($model->name); ?>
								</option>
							<?php endforeach; ?>
						</select>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="chat_assistant"><?php _e('Assistant', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<select id="chat_assistant" class="regular-text">
							<option value=""><?php _e('-- Select Assistant --', 'rds-ai-engine'); ?></option>
							<?php foreach ($assistants as $assistant): ?>
								<option value="<?php echo esc_attr($assistant->id); ?>">
									<?php echo esc_html($assistant->name); ?>
								</option>
							<?php endforeach; ?>
						</select>
					</td>
				</tr>
			</table>
		</div>

		<div class="chat-messages" id="chatMessages">
			<div class="chat-welcome">
				<p><?php _e('Start a conversation by typing a message below.', 'rds-ai-engine'); ?></p>
			</div>
		</div>

		<!-- БЛОК ОТЛАДКИ (изначально скрыт) -->
		<div class="debug-container" id="debugContainer" style="display: none;">
			<h3><?php _e('Debug Information', 'rds-ai-engine'); ?></h3>
			<div class="debug-tabs">
				<button class="debug-tab active" data-tab="request"><?php _e('Request Info', 'rds-ai-engine'); ?></button>
				<button class="debug-tab" data-tab="history"><?php _e('Conversation History', 'rds-ai-engine'); ?></button>
				<button class="debug-tab" data-tab="fullrequest"><?php _e('Full AI Request', 'rds-ai-engine'); ?></button>
				<button class="debug-tab" data-tab="response"><?php _e('AI Response', 'rds-ai-engine'); ?></button>
			</div>
			<div class="debug-content">
				<div class="debug-tab-content active" id="debugRequest">
					<pre><code id="debugRequestContent"><?php _e('No request data yet...', 'rds-ai-engine'); ?></code></pre>
				</div>
				<div class="debug-tab-content" id="debugHistory">
					<pre><code id="debugHistoryContent"><?php _e('No history data yet...', 'rds-ai-engine'); ?></code></pre>
				</div>
				<div class="debug-tab-content" id="debugFullrequest">
					<pre><code id="debugFullrequestContent"><?php _e('No full request data yet...', 'rds-ai-engine'); ?></code></pre>
				</div>
				<div class="debug-tab-content" id="debugResponse">
					<pre><code id="debugResponseContent"><?php _e('No response data yet...', 'rds-ai-engine'); ?></code></pre>
				</div>
			</div>
		</div>

		<div class="chat-input">
			<textarea id="chatInput" placeholder="<?php esc_attr_e('Type your message here...', 'rds-ai-engine'); ?>"
				rows="3"></textarea>
			<div class="chat-actions">
				<button id="sendMessage" class="button button-primary" disabled>
					<?php _e('Send', 'rds-ai-engine'); ?>
				</button>
				<button id="clearChat" class="button">
					<?php _e('Clear Chat', 'rds-ai-engine'); ?>
				</button>
				<button id="toggleDebug" class="button button-secondary">
					<?php _e('Show Debug', 'rds-ai-engine'); ?>
				</button>
			</div>
		</div>
	</div>
</div>
```

## admin/views/tab-history.php

```php
<?php

/**
 * Вкладка управления историей диалогов
 */

$main = RDS_AIE_Main::get_instance();
$history_manager = $main->get_history_manager();

// Настройки по умолчанию
$default_settings = get_option('rds_aie_default_settings', [
	'history_retention_days' => 7,
	'cleanup_enabled' => true
]);

// Обработка сохранения настроек
if (isset($_POST['action']) && $_POST['action'] === 'save_history_settings') {
	if (wp_verify_nonce($_POST['_wpnonce'], 'rds_aie_history_settings')) {
		$settings = [
			'history_retention_days' => intval($_POST['history_retention_days']),
			'cleanup_enabled' => isset($_POST['cleanup_enabled']) ? 1 : 0
		];

		update_option('rds_aie_history_settings', $settings);

		echo '<div class="notice notice-success"><p>' .
			__('Settings saved successfully.', 'rds-ai-engine') .
			'</p></div>';
	}
}

// Обработка очистки истории
if (isset($_POST['action']) && $_POST['action'] === 'cleanup_history') {
	if (wp_verify_nonce($_POST['_wpnonce'], 'rds_aie_cleanup_history')) {
		$days = intval($_POST['cleanup_days']);
		$deleted = $history_manager->cleanup_old_history($days);

		echo '<div class="notice notice-success"><p>' .
			sprintf(__('Deleted %d old conversation records.', 'rds-ai-engine'), $deleted) .
			'</p></div>';
	}
}

// Получаем текущие настройки
$current_settings = get_option('rds_aie_history_settings', $default_settings);
?>

<div class="rds-aie-history">
	<h2><?php _e('Conversation History Settings', 'rds-ai-engine'); ?></h2>

	<div class="history-settings">
		<form method="post">
			<?php wp_nonce_field('rds_aie_history_settings'); ?>
			<input type="hidden" name="action" value="save_history_settings">

			<table class="form-table">
				<tr>
					<th scope="row">
						<label for="history_retention_days"><?php _e('History Retention Period', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<input type="number" id="history_retention_days" name="history_retention_days"
							min="1" max="365" step="1"
							value="<?php echo esc_attr($current_settings['history_retention_days']); ?>">
						<p class="description"><?php _e('Number of days to keep conversation history. Older records will be automatically deleted.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="cleanup_enabled"><?php _e('Automatic Cleanup', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<label>
							<input type="checkbox" id="cleanup_enabled" name="cleanup_enabled" value="1"
								<?php checked($current_settings['cleanup_enabled']); ?>>
							<?php _e('Enable automatic cleanup of old history', 'rds-ai-engine'); ?>
						</label>
					</td>
				</tr>
			</table>

			<p class="submit">
				<button type="submit" class="button button-primary">
					<?php _e('Save Settings', 'rds-ai-engine'); ?>
				</button>
			</p>
		</form>
	</div>

	<div class="history-cleanup">
		<h3><?php _e('Manual History Cleanup', 'rds-ai-engine'); ?></h3>
		<p><?php _e('You can manually delete conversation history older than a specified number of days.', 'rds-ai-engine'); ?></p>

		<form method="post">
			<?php wp_nonce_field('rds_aie_cleanup_history'); ?>
			<input type="hidden" name="action" value="cleanup_history">

			<table class="form-table">
				<tr>
					<th scope="row">
						<label for="cleanup_days"><?php _e('Delete History Older Than', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<input type="number" id="cleanup_days" name="cleanup_days"
							min="1" max="365" step="1" value="7"> <?php _e('days', 'rds-ai-engine'); ?>
					</td>
				</tr>
			</table>

			<p class="submit">
				<button type="submit" class="button button-danger"
					onclick="return confirm('<?php _e('Are you sure you want to delete old conversation history? This action cannot be undone.', 'rds-ai-engine'); ?>');">
					<?php _e('Cleanup Old History', 'rds-ai-engine'); ?>
				</button>
			</p>
		</form>
	</div>

	<div class="history-stats">
		<h3><?php _e('History Statistics', 'rds-ai-engine'); ?></h3>
		<?php
		global $wpdb;
		$table_name = $wpdb->prefix . 'rds_aie_conversations';

		$total_messages = $wpdb->get_var("SELECT COUNT(*) FROM {$table_name}");
		$total_sessions = $wpdb->get_var("SELECT COUNT(DISTINCT session_id) FROM {$table_name}");
		$oldest_record = $wpdb->get_var("SELECT MIN(created_at) FROM {$table_name}");
		?>

		<table class="wp-list-table widefat fixed striped">
			<thead>
				<tr>
					<th><?php _e('Statistic', 'rds-ai-engine'); ?></th>
					<th><?php _e('Value', 'rds-ai-engine'); ?></th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><?php _e('Total Messages', 'rds-ai-engine'); ?></td>
					<td><?php echo esc_html($total_messages ?: 0); ?></td>
				</tr>
				<tr>
					<td><?php _e('Total Conversation Sessions', 'rds-ai-engine'); ?></td>
					<td><?php echo esc_html($total_sessions ?: 0); ?></td>
				</tr>
				<tr>
					<td><?php _e('Oldest Record', 'rds-ai-engine'); ?></td>
					<td><?php echo $oldest_record ? esc_html($oldest_record) : __('No records', 'rds-ai-engine'); ?></td>
				</tr>
			</tbody>
		</table>
	</div>
</div>
```

## admin/views/tab-models.php

```php
<?php

/**
 * Вкладка управления моделями
 */

// Получаем экземпляр плагина
$main = RDS_AIE_Main::get_instance();
$model_manager = $main->get_model_manager();
$assistant_manager = $main->get_assistant_manager();

// Проверяем, что менеджер инициализирован
if (!$model_manager) {
	echo '<div class="notice notice-error"><p>' .
		__('Model manager is not initialized.', 'rds-ai-engine') .
		'</p></div>';
	return;
}

$models = $model_manager->get_all();
$assistants = $assistant_manager->get_all();

// Обработка действий
if (isset($_POST['action'])) {
	$action = sanitize_key($_POST['action']);
	$nonce = isset($_POST['_wpnonce']) ? $_POST['_wpnonce'] : '';

	if (wp_verify_nonce($nonce, 'rds_aie_models')) {
		try {
			switch ($action) {
				case 'save_model':
					$model_data = [
						'id' => isset($_POST['model_id']) ? intval($_POST['model_id']) : 0,
						'name' => sanitize_text_field($_POST['name']),
						'base_url' => esc_url_raw($_POST['base_url']),
						'model_name' => sanitize_text_field($_POST['model_name']),
						'api_key' => sanitize_text_field($_POST['api_key']),
						'max_tokens' => intval($_POST['max_tokens']),
						'is_default' => isset($_POST['is_default']) ? 1 : 0
					];

					$model_manager->save($model_data);
					echo '<div class="notice notice-success"><p>' .
						__('Model saved successfully.', 'rds-ai-engine') .
						'</p></div>';
					break;

				case 'delete_model':
					$model_id = intval($_POST['model_id']);
					$model_manager->delete($model_id);
					echo '<div class="notice notice-success"><p>' .
						__('Model deleted successfully.', 'rds-ai-engine') .
						'</p></div>';
					break;
			}

			// Обновляем список моделей
			$models = $model_manager->get_all();
		} catch (Exception $e) {
			echo '<div class="notice notice-error"><p>' .
				esc_html($e->getMessage()) .
				'</p></div>';
		}
	}
}

// Получение данных модели для редактирования
$edit_model = null;
if (isset($_GET['edit'])) {
	$edit_model = $model_manager->get(intval($_GET['edit']));
}

// Получение модели для удаления
$delete_model = null;
if (isset($_GET['delete'])) {
	$delete_model = $model_manager->get(intval($_GET['delete']));
}
?>

<div class="rds-aie-models">
	<?php if ($delete_model): ?>
		<!-- Форма подтверждения удаления -->
		<div class="confirm-delete">
			<h2><?php _e('Confirm Delete', 'rds-ai-engine'); ?></h2>
			<p><?php printf(
					__('Are you sure you want to delete model "%s"?', 'rds-ai-engine'),
					esc_html($delete_model->name)
				); ?></p>
			<form method="post">
				<?php wp_nonce_field('rds_aie_models'); ?>
				<input type="hidden" name="action" value="delete_model">
				<input type="hidden" name="model_id" value="<?php echo esc_attr($delete_model->id); ?>">
				<button type="submit" class="button button-danger"><?php _e('Delete', 'rds-ai-engine'); ?></button>
				<a href="?page=rds-aie&tab=models" class="button"><?php _e('Cancel', 'rds-ai-engine'); ?></a>
			</form>
		</div>
	<?php endif; ?>

	<!-- Форма добавления/редактирования модели -->
	<div class="model-form">
		<h2><?php echo $edit_model ? __('Edit Model', 'rds-ai-engine') : __('Add New Model', 'rds-ai-engine'); ?></h2>
		<form method="post">
			<?php wp_nonce_field('rds_aie_models'); ?>
			<input type="hidden" name="action" value="save_model">
			<input type="hidden" name="model_id" value="<?php echo $edit_model ? esc_attr($edit_model->id) : 0; ?>">

			<table class="form-table">
				<tr>
					<th scope="row">
						<label for="name"><?php _e('Model Name', 'rds-ai-engine'); ?> *</label>
					</th>
					<td>
						<input type="text" id="name" name="name" class="regular-text"
							value="<?php echo $edit_model ? esc_attr($edit_model->name) : ''; ?>" required>
						<p class="description"><?php _e('A descriptive name for this AI model configuration.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="base_url"><?php _e('Base URL', 'rds-ai-engine'); ?> *</label>
					</th>
					<td>
						<input type="url" id="base_url" name="base_url" class="regular-text"
							value="<?php echo $edit_model ? esc_attr($edit_model->base_url) : 'https://api.openai.com/v1'; ?>" required>
						<p class="description"><?php _e('Base URL for the OpenAI-compatible API.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="model_name"><?php _e('AI Model Name', 'rds-ai-engine'); ?> *</label>
					</th>
					<td>
						<input type="text" id="model_name" name="model_name" class="regular-text"
							value="<?php echo $edit_model ? esc_attr($edit_model->model_name) : 'gpt-3.5-turbo'; ?>" required>
						<p class="description"><?php _e('The specific model name (e.g., gpt-3.5-turbo, gpt-4).', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="api_key"><?php _e('API Key', 'rds-ai-engine'); ?> *</label>
					</th>
					<td>
						<input type="password" id="api_key" name="api_key" class="regular-text"
							value="<?php echo $edit_model ? esc_attr($edit_model->api_key) : ''; ?>" required>
						<p class="description"><?php _e('API key for authentication.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="max_tokens"><?php _e('Max Tokens', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<input type="number" id="max_tokens" name="max_tokens" min="1" max="32000" step="1"
							value="<?php echo $edit_model ? esc_attr($edit_model->max_tokens) : 4096; ?>">
						<p class="description"><?php _e('Maximum number of tokens in the response.', 'rds-ai-engine'); ?></p>
					</td>
				</tr>
				<tr>
					<th scope="row">
						<label for="is_default"><?php _e('Default Model', 'rds-ai-engine'); ?></label>
					</th>
					<td>
						<label>
							<input type="checkbox" id="is_default" name="is_default" value="1"
								<?php checked($edit_model ? $edit_model->is_default : 0); ?>>
							<?php _e('Set as default model', 'rds-ai-engine'); ?>
						</label>
					</td>
				</tr>
			</table>

			<p class="submit">
				<button type="submit" class="button button-primary">
					<?php echo $edit_model ? __('Update Model', 'rds-ai-engine') : __('Add Model', 'rds-ai-engine'); ?>
				</button>
				<?php if ($edit_model): ?>
					<a href="?page=rds-aie&tab=models" class="button"><?php _e('Cancel', 'rds-ai-engine'); ?></a>
				<?php endif; ?>
			</p>
		</form>
	</div>

	<!-- Список моделей -->
	<div class="models-list">
		<h2><?php _e('Available Models', 'rds-ai-engine'); ?></h2>

		<?php if (empty($models)): ?>
			<p><?php _e('No models configured yet.', 'rds-ai-engine'); ?></p>
		<?php else: ?>
			<table class="wp-list-table widefat fixed striped">
				<thead>
					<tr>
						<th><?php _e('Name', 'rds-ai-engine'); ?></th>
						<th><?php _e('Base URL', 'rds-ai-engine'); ?></th>
						<th><?php _e('Model', 'rds-ai-engine'); ?></th>
						<th><?php _e('Max Tokens', 'rds-ai-engine'); ?></th>
						<th><?php _e('Default', 'rds-ai-engine'); ?></th>
						<th><?php _e('Actions', 'rds-ai-engine'); ?></th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($models as $model): ?>
						<tr>
							<td><?php echo esc_html($model->name); ?></td>
							<td><?php echo esc_html($model->base_url); ?></td>
							<td><?php echo esc_html($model->model_name); ?></td>
							<td><?php echo esc_html($model->max_tokens); ?></td>
							<td>
								<?php if ($model->is_default): ?>
									<span class="dashicons dashicons-yes" style="color: #46b450;"></span>
								<?php endif; ?>
							</td>
							<td>
								<a href="?page=rds-aie&tab=models&edit=<?php echo esc_attr($model->id); ?>"
									class="button button-small">
									<?php _e('Edit', 'rds-ai-engine'); ?>
								</a>
								<a href="?page=rds-aie&tab=models&delete=<?php echo esc_attr($model->id); ?>"
									class="button button-small button-link-delete">
									<?php _e('Delete', 'rds-ai-engine'); ?>
								</a>
							</td>
						</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		<?php endif; ?>
	</div>
</div>
```

## includes/class-ai-client.php

```php
<?php

/**
 * Клиент для работы с OpenAI-совместимыми API
 */

class RDS_AIE_AI_Client
{

	private $model_manager;
	private $assistant_manager;
	private $history_manager;  // НОВЫЙ

	public function __construct($model_manager, $assistant_manager, $history_manager)
	{
		$this->model_manager = $model_manager;
		$this->assistant_manager = $assistant_manager;
		$this->history_manager = $history_manager;  // НОВЫЙ
	}

	/**
	 * Основной метод для отправки сообщения в ИИ
	 */
	public function chat_completion($params)
	{
		$defaults = [
			'model_id' => 0,
			'assistant_id' => 0,
			'message' => '',
			'session_id' => '',
			'plugin_id' => 'default',
			'override_params' => []
		];

		$params = wp_parse_args($params, $defaults);

		// Получение настроек модели и ассистента
		$model = $this->get_model_settings($params['model_id'], $params['assistant_id']);
		$assistant = $this->assistant_manager->get($params['assistant_id']);
		$assistant_params = $this->assistant_manager->get_default_params($params['assistant_id']);

		// Объединение параметров
		$request_params = $this->merge_params($assistant_params, $params['override_params']);

		// Получаем session_id
		$session_id = $this->get_session_id($params['session_id'], $params['plugin_id']);

		// Подготовка сообщений для отправки
		$messages = $this->prepare_messages(
			$params['assistant_id'],
			$params['message'],
			$session_id,
			$params['plugin_id'],
			$assistant
		);

		// Сохраняем сообщение пользователя в историю
		$this->history_manager->save_message([
			'session_id' => $session_id,
			'plugin_id' => $params['plugin_id'],
			'assistant_id' => $params['assistant_id'],
			'model_id' => !empty($params['model_id']) ? $params['model_id'] : null,
			'role' => 'user',
			'content' => $params['message'],
			'tokens' => $this->history_manager->count_tokens($params['message'])
		]);

		// Подготовка данных для запроса
		$request_data = $this->prepare_request_data($model['model_name'], $messages, $request_params);

		// Отправка запроса
		$response = $this->make_api_request($model['base_url'], $model['api_key'], $request_data);

		// Извлечение ответа
		$response_content = '';
		if (isset($response['choices'][0]['message']['content'])) {
			$response_content = trim($response['choices'][0]['message']['content']);
		} elseif (isset($response['error']['message'])) {
			throw new Exception($response['error']['message']);
		} elseif (isset($response['message']['content'])) {
			$response_content = trim($response['message']['content']);
		} else {
			throw new Exception(__('Unknown API response format.', 'rds-ai-engine'));
		}

		// Сохраняем ответ ассистента в историю
		$this->history_manager->save_message([
			'session_id' => $session_id,
			'plugin_id' => $params['plugin_id'],
			'assistant_id' => $params['assistant_id'],
			'model_id' => !empty($params['model_id']) ? $params['model_id'] : null,
			'role' => 'assistant',
			'content' => $response_content,
			'tokens' => $this->history_manager->count_tokens($response_content)
		]);

		return $response_content;
	}

	/**
	 * Подготовка сообщений с учетом истории
	 */
	private function prepare_messages($assistant_id, $user_message, $session_id, $plugin_id, $assistant)
	{
		$messages = [];

		// Добавляем системный промпт
		$system_prompt = $this->assistant_manager->get_system_prompt($assistant_id);
		if (!empty($system_prompt)) {
			$messages[] = [
				'role' => 'system',
				'content' => $system_prompt
			];

			// Сохраняем системный промпт в историю (только если его еще нет)
			$this->save_system_prompt_if_needed($assistant_id, $session_id, $plugin_id, $system_prompt);
		}

		// Добавляем историю диалога, если включена
		if ($assistant && $assistant->history_enabled) {
			$history_messages = $this->history_manager->get_assistant_history(
				$session_id,
				$assistant_id,
				[
					'history_enabled' => $assistant->history_enabled,
					'history_messages_count' => $assistant->history_messages_count
				]
			);

			// ВАЖНО: Фильтруем системные сообщения (они уже добавлены)
			foreach ($history_messages as $history_message) {
				// Пропускаем системные сообщения (role === 'system')
				// и текущее пользовательское сообщение (если оно уже есть в истории)
				if ($history_message['role'] !== 'system') {
					// Проверяем, не является ли это текущим сообщением пользователя
					if (!($history_message['role'] === 'user' && $history_message['content'] === $user_message)) {
						$messages[] = $history_message;
					}
				}
			}
		}

		// Добавляем текущее сообщение пользователя
		$messages[] = [
			'role' => 'user',
			'content' => $user_message
		];

		// Отладочное логирование
		if (defined('WP_DEBUG') && WP_DEBUG) {
			error_log('RDS AI Engine - Prepared messages: ' . json_encode([
				'total_messages' => count($messages),
				'system_prompt_length' => strlen($system_prompt),
				'history_messages_count' => $assistant ? $assistant->history_messages_count : 0,
				'history_enabled' => $assistant ? $assistant->history_enabled : false,
				'messages_sample' => array_map(function ($msg) {
					return [
						'role' => $msg['role'],
						'content_length' => strlen($msg['content']),
						'content_preview' => substr($msg['content'], 0, 50) . '...'
					];
				}, $messages)
			]));
		}

		return $messages;
	}

	/**
	 * Сохранение системного промпта в историю (один раз)
	 */
	private function save_system_prompt_if_needed($assistant_id, $session_id, $plugin_id, $system_prompt)
	{
		// Проверяем, есть ли уже системный промпт для этой сессии
		$existing_system = $this->history_manager->get_history($session_id, 1);
		$has_system = false;

		foreach ($existing_system as $message) {
			if ($message->role === 'system') {
				$has_system = true;
				break;
			}
		}

		// Если системного промпта еще нет - сохраняем
		if (!$has_system) {
			$this->history_manager->save_message([
				'session_id' => $session_id,
				'plugin_id' => $plugin_id,
				'assistant_id' => $assistant_id,
				'role' => 'system',
				'content' => $system_prompt,
				'tokens' => $this->history_manager->count_tokens($system_prompt)
			]);
		}
	}

	/**
	 * Получение или создание session_id
	 */
	private function get_session_id($provided_session_id, $plugin_id)
	{
		if (!empty($provided_session_id)) {
			return $provided_session_id;
		}

		// Для плагина по умолчанию используем cookie-based сессию
		if ($plugin_id === 'default') {
			return $this->history_manager->get_current_session_id();
		}

		// Для других плагинов генерируем на основе plugin_id
		return md5($plugin_id . '_' . time() . '_' . wp_rand());
	}

	/**
	 * Подготовка данных запроса с правильными типами
	 */
	private function prepare_request_data($model_name, $messages, $params)
	{
		$request_data = [
			'model' => $model_name,
			'messages' => $messages
		];

		// Добавляем max_tokens, если указан (как число)
		if (isset($params['max_tokens'])) {
			$request_data['max_tokens'] = (int)$params['max_tokens'];
		}

		// Добавляем temperature, если указана (как число с плавающей точкой)
		if (isset($params['temperature'])) {
			$request_data['temperature'] = (float)$params['temperature'];
		}

		// Дополнительные параметры для совместимости
		$additional_params = [
			'top_p' => 'float',
			'frequency_penalty' => 'float',
			'presence_penalty' => 'float',
			'stream' => 'bool',
			'stop' => 'array'
		];

		foreach ($additional_params as $param => $type) {
			if (isset($params[$param])) {
				switch ($type) {
					case 'float':
						$request_data[$param] = (float)$params[$param];
						break;
					case 'int':
						$request_data[$param] = (int)$params[$param];
						break;
					case 'bool':
						$request_data[$param] = (bool)$params[$param];
						break;
					case 'array':
						$request_data[$param] = (array)$params[$param];
						break;
					default:
						$request_data[$param] = $params[$param];
				}
			}
		}

		return $request_data;
	}

	/**
	 * Получение настроек модели
	 */
	private function get_model_settings($model_id, $assistant_id)
	{
		$model = null;

		// Если указан конкретный model_id - используем его
		if (!empty($model_id)) {
			$model = $this->model_manager->get($model_id);
		}
		// Иначе используем модель по умолчанию из ассистента
		elseif (!empty($assistant_id)) {
			$assistant = $this->assistant_manager->get($assistant_id);
			if ($assistant && !empty($assistant->default_model_id)) {
				$model = $this->model_manager->get($assistant->default_model_id);
			}
		}

		// Если модель все еще не найдена, берем модель по умолчанию
		if (empty($model)) {
			$model = $this->model_manager->get_default_model();
		}

		if (empty($model)) {
			throw new Exception(__('No AI model configured.', 'rds-ai-engine'));
		}

		return [
			'base_url' => $model->base_url,
			'model_name' => $model->model_name,
			'api_key' => $model->api_key
		];
	}

	/**
	 * Объединение параметров
	 */
	private function merge_params($assistant_params, $override_params)
	{
		if (empty($assistant_params)) {
			return $override_params;
		}

		return array_merge((array)$assistant_params, $override_params);
	}

	/**
	 * Отправка запроса к API
	 */
	private function make_api_request($base_url, $api_key, $data)
	{
		$url = trailingslashit($base_url) . 'chat/completions';

		// Для отладки - логируем запрос
		if (defined('WP_DEBUG') && WP_DEBUG) {
			error_log('RDS AI Engine Request to: ' . $url);
			error_log('RDS AI Engine Request data: ' . json_encode($data));
		}

		$args = [
			'timeout' => 60,
			'headers' => [
				'Content-Type' => 'application/json',
				'Authorization' => 'Bearer ' . $api_key
			],
			'body' => wp_json_encode($data)
		];

		$response = wp_remote_post($url, $args);

		if (is_wp_error($response)) {
			throw new Exception($response->get_error_message());
		}

		$body = wp_remote_retrieve_body($response);
		$response_code = wp_remote_retrieve_response_code($response);

		// Для отладки - логируем ответ
		if (defined('WP_DEBUG') && WP_DEBUG) {
			error_log('RDS AI Engine Response code: ' . $response_code);
			error_log('RDS AI Engine Response body: ' . $body);
		}

		$decoded = json_decode($body, true);

		if (json_last_error() !== JSON_ERROR_NONE) {
			// Если это не JSON, возможно, это ошибка сервера
			if (strpos($body, '<html') !== false || strpos($body, '<!DOCTYPE') !== false) {
				throw new Exception(__('Server returned HTML instead of JSON. Check the API URL.', 'rds-ai-engine'));
			}
			throw new Exception(__('Invalid JSON response from API. Response: ', 'rds-ai-engine') . substr($body, 0, 200));
		}

		if ($response_code < 200 || $response_code >= 300) {
			$error_msg = isset($decoded['error']['message'])
				? $decoded['error']['message']
				: (isset($decoded['message'])
					? $decoded['message']
					: sprintf(__('API request failed with status code %d', 'rds-ai-engine'), $response_code));
			throw new Exception($error_msg);
		}

		return $decoded;
	}

	/**
	 * Проверка соединения с API
	 */
	public function test_connection($base_url, $api_key, $model_name)
	{
		try {
			$test_data = $this->prepare_request_data($model_name, [
				['role' => 'user', 'content' => 'Hello']
			], ['max_tokens' => 5]);

			$response = $this->make_api_request($base_url, $api_key, $test_data);
			return [
				'success' => true,
				'message' => __('Connection successful.', 'rds-ai-engine')
			];
		} catch (Exception $e) {
			return [
				'success' => false,
				'message' => $e->getMessage()
			];
		}
	}

	/**
	 * Получение истории диалога (для отладки)
	 */
	public function get_conversation_history($session_id, $limit = 10)
	{
		return $this->history_manager->get_formatted_history($session_id, $limit);
	}

	/**
	 * Получение детальной информации о подготовке запроса (для отладки)
	 */
	public function get_debug_info($session_id, $assistant_id, $user_message)
	{
		$assistant = $this->assistant_manager->get($assistant_id);

		return [
			'session_id' => $session_id,
			'assistant' => $assistant ? [
				'id' => $assistant->id,
				'name' => $assistant->name,
				'history_enabled' => (bool)$assistant->history_enabled,
				'history_messages_count' => $assistant->history_messages_count
			] : null,
			'history_raw' => $this->history_manager->get_history($session_id, 20),
			'history_formatted' => $this->history_manager->get_formatted_history($session_id, 20),
			'messages_prepared' => $this->prepare_messages(
				$assistant_id,
				$user_message,
				$session_id,
				'test_chat',
				$assistant
			),
			'timestamp' => current_time('mysql')
		];
	}

	/**
	 * Получение параметров запроса для отладки
	 */
	public function get_request_params_debug($assistant_id, $model_id)
	{
		$model = $this->get_model_settings($model_id, $assistant_id);
		$assistant_params = $this->assistant_manager->get_default_params($assistant_id);

		return [
			'model' => $model['model_name'],
			'base_url' => $model['base_url'],
			'assistant_params' => $assistant_params,
			'temperature' => isset($assistant_params['temperature']) ? (float)$assistant_params['temperature'] : 0.7,
			'max_tokens' => isset($assistant_params['max_tokens']) ? (int)$assistant_params['max_tokens'] : 1000
		];
	}

	/**
	 * Подготовка сообщений с учетом истории (публичная версия для отладки)
	 */
	public function prepare_messages_debug($assistant_id, $user_message, $session_id, $plugin_id)
	{
		$assistant = $this->assistant_manager->get($assistant_id);
		return $this->prepare_messages($assistant_id, $user_message, $session_id, $plugin_id, $assistant);
	}

	/**
	 * Подготовка полного JSON запроса для отладки
	 */
	public function get_full_request_json_debug($assistant_id, $model_id, $user_message, $session_id, $plugin_id)
	{
		$model = $this->get_model_settings($model_id, $assistant_id);
		$assistant = $this->assistant_manager->get($assistant_id);
		$assistant_params = $this->assistant_manager->get_default_params($assistant_id);

		$messages = $this->prepare_messages($assistant_id, $user_message, $session_id, $plugin_id, $assistant);

		$request_data = [
			'model' => $model['model_name'],
			'messages' => $messages,
			'max_tokens' => isset($assistant_params['max_tokens']) ? (int)$assistant_params['max_tokens'] : 1000,
			'temperature' => isset($assistant_params['temperature']) ? (float)$assistant_params['temperature'] : 0.7
		];

		return [
			'url' => trailingslashit($model['base_url']) . 'chat/completions',
			'headers' => [
				'Content-Type' => 'application/json',
				'Authorization' => 'Bearer ' . substr($model['api_key'], 0, 10) . '...' // Безопасный показ ключа
			],
			'body' => $request_data,
			'body_json' => json_encode($request_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)
		];
	}
}

```

## includes/class-assistant-manager.php

```php
<?php

/**
 * Класс для управления ассистентами
 */

class RDS_AIE_Assistant_Manager
{

	private $db;

	public function __construct($db)
	{
		$this->db = $db;
	}

	/**
	 * Получение всех ассистентов
	 */
	public function get_all()
	{
		return $this->db->get_assistants();
	}

	/**
	 * Получение ассистента по ID
	 */
	public function get($id)
	{
		return $this->db->get_assistant($id);
	}

	/**
	 * Сохранение ассистента
	 */
	public function save($data)
	{
		// Валидация данных
		if (empty($data['name'])) {
			throw new Exception(__('Assistant name is required.', 'rds-ai-engine'));
		}

		if (empty($data['system_prompt'])) {
			throw new Exception(__('System prompt is required.', 'rds-ai-engine'));
		}

		return $this->db->save_assistant($data);
	}

	/**
	 * Удаление ассистента
	 */
	public function delete($id)
	{
		return $this->db->delete_assistant($id);
	}

	/**
	 * Получение системного промпта ассистента
	 */
	public function get_system_prompt($assistant_id)
	{
		$assistant = $this->get($assistant_id);
		return $assistant ? $assistant->system_prompt : '';
	}

	/**
	 * Получение параметров ассистента по умолчанию
	 */
	public function get_default_params($assistant_id)
	{
		$assistant = $this->get($assistant_id);

		if (!$assistant) {
			return null;
		}

		return [
			'max_tokens' => $assistant->max_tokens,
			'temperature' => $assistant->temperature,
			'history_enabled' => $assistant->history_enabled,
			'history_messages_count' => $assistant->history_messages_count,
			'knowledge_base_enabled' => $assistant->knowledge_base_enabled,
			'default_model_id' => $assistant->default_model_id
		];
	}
}

```

## includes/class-helper.php

```php
<?php

/**
 * Вспомогательный класс RDS AI Engine
 */

class RDS_AIE_Helper
{

	/**
	 * Создание nonce для форм
	 */
	public static function create_nonce($action)
	{
		return wp_create_nonce($action);
	}

	/**
	 * Проверка nonce
	 */
	public static function verify_nonce($nonce, $action)
	{
		return wp_verify_nonce($nonce, $action);
	}

	/**
	 * Получение URL страницы плагина
	 */
	public static function get_page_url($tab = '')
	{
		$url = admin_url('admin.php?page=rds-aie');
		if (!empty($tab)) {
			$url .= '&tab=' . urlencode($tab);
		}
		return $url;
	}
}

```

## includes/class-history-manager.php

```php
<?php

/**
 * Класс для управления историей диалогов
 */

class RDS_AIE_History_Manager
{

	private $db;

	public function __construct($db)
	{
		$this->db = $db;
	}

	/**
	 * Сохранение сообщения в историю
	 */
	public function save_message($params = [])
	{
		$defaults = [
			'plugin_id' => 'default',
			'user_id' => get_current_user_id(),
			'session_id' => '',
			'assistant_id' => null,
			'model_id' => null,
			'role' => 'user',
			'content' => '',
			'tokens' => 0
		];

		$params = wp_parse_args($params, $defaults);

		// Если нет session_id, генерируем новый
		if (empty($params['session_id'])) {
			$params['session_id'] = $this->generate_session_id();
		}

		// Сохраняем сообщение
		return $this->db->save_conversation_message($params);
	}

	/**
	 * Получение истории диалога
	 */
	public function get_history($session_id, $limit = 10)
	{
		return $this->db->get_conversation_history($session_id, $limit);
	}

	/**
	 * Получение истории в формате для OpenAI API
	 */
	public function get_formatted_history($session_id, $limit = 10)
	{
		$history = $this->get_history($session_id, $limit);
		$formatted = [];

		foreach ($history as $message) {
			$formatted[] = [
				'role' => $message->role,
				'content' => $message->content
			];
		}

		return $formatted;
	}

	/**
	 * Получение истории с учетом настроек ассистента
	 */
	public function get_assistant_history($session_id, $assistant_id, $assistant_settings = [])
	{
		$limit = isset($assistant_settings['history_messages_count'])
			? (int)$assistant_settings['history_messages_count']
			: 10;

		// Получаем ВСЮ историю
		$all_history = $this->get_formatted_history($session_id, 100);

		// Если история отключена - возвращаем пустой массив
		if (isset($assistant_settings['history_enabled']) && !$assistant_settings['history_enabled']) {
			return [];
		}

		// Ограничиваем количество сообщений (берем последние N)
		if ($limit > 0 && count($all_history) > $limit) {
			$all_history = array_slice($all_history, -$limit);
		}

		return $all_history;
	}

	/**
	 * Очистка истории диалога
	 */
	public function clear_history($session_id)
	{
		return $this->db->delete_conversation_session($session_id);
	}

	/**
	 * Очистка старых записей
	 */
	public function cleanup_old_history($days = 7)
	{
		return $this->db->cleanup_old_conversations($days);
	}

	/**
	 * Генерация session_id
	 */
	private function generate_session_id()
	{
		// Используем комбинацию из user_id, времени и случайной строки
		$user_id = get_current_user_id();
		$time = time();
		$random = wp_generate_password(8, false);

		return md5("{$user_id}_{$time}_{$random}");
	}

	/**
	 * Получение session_id для текущей сессии
	 */
	public function get_current_session_id()
	{
		// Пытаемся получить session_id из cookie
		if (!empty($_COOKIE['rds_aie_session'])) {
			return sanitize_text_field($_COOKIE['rds_aie_session']);
		}

		// Или генерируем новый
		$session_id = $this->generate_session_id();

		// Сохраняем в cookie на 24 часа
		setcookie('rds_aie_session', $session_id, time() + 86400, '/');

		return $session_id;
	}

	/**
	 * Подсчет токенов в сообщении (упрощенный метод)
	 */
	public function count_tokens($text)
	{
		// Упрощенный подсчет: примерно 4 символа = 1 токен
		// В реальном проекте лучше использовать библиотеку для подсчета токенов
		return ceil(strlen($text) / 4);
	}
}

```

## includes/class-main.php

```php
<?php

/**
 * Главный класс плагина RDS AI Engine
 */

class RDS_AIE_Main
{

	/**
	 * Экземпляр класса (Singleton)
	 */
	private static $instance = null;

	/**
	 * Менеджеры компонентов
	 */
	private $model_manager = null;
	private $assistant_manager = null;
	private $history_manager = null;
	private $db = null;
	private $ai_client = null;

	/**
	 * Конструктор (закрытый для Singleton)
	 */
	private function __construct()
	{
		$this->init_hooks();
	}

	/**
	 * Получение экземпляра класса
	 */
	public static function get_instance()
	{
		if (null === self::$instance) {
			self::$instance = new self();
		}
		return self::$instance;
	}

	/**
	 * Регистрация предустановленных ассистентов
	 * (для других плагинов)
	 */
	public function register_default_assistants()
	{
		// Пример предустановленных ассистентов
		$default_assistants = apply_filters('rds_aie_default_assistants', []);

		foreach ($default_assistants as $assistant_data) {
			$this->get_or_create_assistant(
				$assistant_data['name'],
				$assistant_data
			);
		}
	}

	/**
	 * Инициализация хуков WordPress
	 */
	private function init_hooks()
	{
		// Инициализация после загрузки всех плагинов
		add_action('plugins_loaded', [$this, 'init_components']);
		add_action('plugins_loaded', [$this, 'register_default_assistants'], 5);

		// Инициализация админки - позже, чтобы компоненты успели загрузиться
		if (is_admin()) {
			add_action('admin_menu', [$this, 'add_admin_menu'], 20);
			add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_scripts'], 20);
			add_action('wp_ajax_rds_aie_test_chat', [$this, 'ajax_test_chat']);
		}

		// Крон для очистки старой истории
		add_action('rds_aie_daily_cleanup', [$this, 'daily_cleanup']);
		add_action('init', [$this, 'schedule_cleanup']);
	}

	/**
	 * Планирование ежедневной очистки
	 */
	public function schedule_cleanup()
	{
		if (!wp_next_scheduled('rds_aie_daily_cleanup')) {
			wp_schedule_event(time(), 'daily', 'rds_aie_daily_cleanup');
		}
	}

	/**
	 * Ежедневная очистка старой истории
	 */
	public function daily_cleanup()
	{
		$settings = get_option('rds_aie_history_settings', [
			'history_retention_days' => 7,
			'cleanup_enabled' => true
		]);

		if ($settings['cleanup_enabled'] && $settings['history_retention_days'] > 0) {
			$this->get_history_manager()->cleanup_old_history($settings['history_retention_days']);
		}
	}

	/**
	 * Инициализация компонентов
	 */
	public function init_components()
	{
		// Загружаем класс DB если еще не загружен
		if (!class_exists('RDS_AIE_DB')) {
			require_once RDS_AIE_PLUGIN_DIR . 'includes/class-db.php';
		}

		$this->db = new RDS_AIE_DB();
		$this->model_manager = new RDS_AIE_Model_Manager($this->db);
		$this->assistant_manager = new RDS_AIE_Assistant_Manager($this->db);

		// Загружаем класс History Manager если еще не загружен
		if (!class_exists('RDS_AIE_History_Manager')) {
			require_once RDS_AIE_PLUGIN_DIR . 'includes/class-history-manager.php';
		}

		$this->history_manager = new RDS_AIE_History_Manager($this->db);

		// Загружаем AI Client если еще не загружен
		if (!class_exists('RDS_AIE_AI_Client')) {
			require_once RDS_AIE_PLUGIN_DIR . 'includes/class-ai-client.php';
		}

		$this->ai_client = new RDS_AIE_AI_Client(
			$this->model_manager,
			$this->assistant_manager,
			$this->history_manager
		);
	}

	/**
	 * Получить менеджер моделей (с проверкой инициализации)
	 */
	public function get_model_manager()
	{
		if (null === $this->model_manager) {
			$this->init_components();
		}
		return $this->model_manager;
	}

	/**
	 * Получить менеджер ассистентов (с проверкой инициализации)
	 */
	public function get_assistant_manager()
	{
		if (null === $this->assistant_manager) {
			$this->init_components();
		}
		return $this->assistant_manager;
	}

	/**
	 * Получить менеджер истории (с проверкой инициализации)
	 */
	public function get_history_manager()
	{
		if (null === $this->history_manager) {
			$this->init_components();
		}
		return $this->history_manager;
	}

	/**
	 * Получить AI клиент (с проверкой инициализации)
	 */
	public function get_ai_client()
	{
		if (null === $this->ai_client) {
			$this->init_components();
		}
		return $this->ai_client;
	}

	/**
	 * Добавление меню в админку
	 */
	public function add_admin_menu()
	{
		// Главное меню
		add_menu_page(
			__('RDS AI Engine', 'rds-ai-engine'),
			__('RDS AI Engine', 'rds-ai-engine'),
			'edit_posts',
			'rds-aie',
			[$this, 'render_admin_page'],
			'dashicons-nametag',
			30
		);

		// Скрываем подменю из списка
		remove_submenu_page('rds-aie', 'rds-aie');
	}

	/**
	 * Рендеринг страницы админки
	 */
	public function render_admin_page()
	{
		// Проверка прав
		if (!current_user_can('edit_posts')) {
			wp_die(__('You do not have sufficient permissions to access this page.', 'rds-ai-engine'));
		}

		// Убедимся, что компоненты инициализированы
		$this->get_model_manager();
		$this->get_assistant_manager();

		// Получение текущей вкладки
		$current_tab = isset($_GET['tab']) ? sanitize_key($_GET['tab']) : 'models';

		// Подключение шаблона
		include RDS_AIE_PLUGIN_DIR . 'admin/views/admin-page.php';
	}

	/**
	 * Подключение скриптов и стилей в админке
	 */
	public function enqueue_admin_scripts($hook)
	{
		// Подключаем только на страницах плагина
		if (strpos($hook, 'rds-aie') === false) {
			return;
		}

		// CSS
		wp_enqueue_style(
			'rds-aie-admin',
			RDS_AIE_PLUGIN_URL . 'admin/css/admin.css',
			[],
			RDS_AIE_VERSION
		);

		// JS для тестового чата
		if (isset($_GET['tab']) && $_GET['tab'] === 'chat') {
			wp_enqueue_script(
				'rds-aie-chat',
				RDS_AIE_PLUGIN_URL . 'admin/js/chat.js',
				['jquery'],
				RDS_AIE_VERSION,
				true
			);

			// Локализация для JS
			wp_localize_script('rds-aie-chat', 'rds_aie_ajax', [
				'ajax_url' => admin_url('admin-ajax.php'),
				'nonce' => wp_create_nonce('rds_aie_chat_nonce'),
				'loading_text' => __('Loading...', 'rds-ai-engine'),
				'error_text' => __('An error occurred. Please try again.', 'rds-ai-engine'),
				'select_model_or_assistant' => __('Please select a model or assistant.', 'rds-ai-engine'),
				'confirm_clear' => __('Are you sure you want to clear the chat?', 'rds-ai-engine'),
				'chat_welcome' => __('Start a conversation by typing a message below.', 'rds-ai-engine'),
				'show_debug' => __('Show Debug', 'rds-ai-engine'),
				'hide_debug' => __('Hide Debug', 'rds-ai-engine'),
				'no_request' => __('No request data yet...', 'rds-ai-engine'),
				'no_history' => __('No history data yet...', 'rds-ai-engine'),
				'no_response' => __('No response data yet...', 'rds-ai-engine')
			]);
		}
	}

	/**
	 * AJAX обработчик тестового чата
	 */
	public function ajax_test_chat()
	{
		// Проверка nonce
		check_ajax_referer('rds_aie_chat_nonce', 'nonce');

		// Проверка прав
		if (!current_user_can('edit_posts')) {
			wp_die('Unauthorized', 401);
		}

		// Получение данных
		$message = isset($_POST['message']) ? sanitize_textarea_field($_POST['message']) : '';
		$model_id = isset($_POST['model_id']) ? intval($_POST['model_id']) : 0;
		$assistant_id = isset($_POST['assistant_id']) ? intval($_POST['assistant_id']) : 0;
		$session_id = isset($_POST['session_id']) ? sanitize_text_field($_POST['session_id']) : '';

		if (empty($message)) {
			wp_send_json_error(['message' => __('Message is empty.', 'rds-ai-engine')]);
		}

		try {
			// Сначала получаем AI клиент
			$ai_client = $this->get_ai_client();

			// Получаем отладочную информацию ДО отправки запроса
			$debug_info = $this->get_debug_info_for_chat($session_id, $assistant_id, $message, $model_id);

			// Получение ответа от ИИ
			$response = $ai_client->chat_completion([
				'model_id' => $model_id,
				'assistant_id' => $assistant_id,
				'message' => $message,
				'session_id' => $session_id,
				'plugin_id' => 'test_chat'
			]);

			$result = [
				'response' => $response,
				'message' => __('Success', 'rds-ai-engine'),
				'debug' => $debug_info
			];

			wp_send_json_success($result);
		} catch (Exception $e) {
			wp_send_json_error([
				'message' => $e->getMessage()
			]);
		}
	}

	/**
	 * Получение отладочной информации для чата
	 */
	private function get_debug_info_for_chat($session_id, $assistant_id, $message, $model_id)
	{
		$history_manager = $this->get_history_manager();
		$assistant_manager = $this->get_assistant_manager();
		$model_manager = $this->get_model_manager();

		$assistant = $assistant_manager->get($assistant_id);
		$model = $model_id ? $model_manager->get($model_id) : null;

		// Получаем историю из БД
		$raw_history = $history_manager->get_history($session_id, 20);
		$formatted_history = $history_manager->get_formatted_history($session_id, 20);

		// Получаем, что будет отправлено в ИИ
		$ai_client = $this->get_ai_client();
		$messages_to_send = $ai_client->prepare_messages_debug($assistant_id, $message, $session_id, 'test_chat');

		// Получаем настройки запроса
		$request_params = $ai_client->get_request_params_debug($assistant_id, $model_id);

		// Получаем полный JSON запроса
		$full_request = $ai_client->get_full_request_json_debug($assistant_id, $model_id, $message, $session_id, 'test_chat');

		return [
			'session_id' => $session_id,
			'assistant' => $assistant ? [
				'id' => $assistant->id,
				'name' => $assistant->name,
				'history_enabled' => (bool)$assistant->history_enabled,
				'history_messages_count' => $assistant->history_messages_count,
				'temperature' => $assistant->temperature,
				'max_tokens' => $assistant->max_tokens
			] : null,
			'full_request_json' => $full_request,
			'model' => $model ? [
				'id' => $model->id,
				'name' => $model->name,
				'model_name' => $model->model_name,
				'base_url' => $model->base_url
			] : null,
			'database_history' => [
				'raw_count' => count($raw_history),
				'raw' => $raw_history,
				'formatted_count' => count($formatted_history),
				'formatted' => $formatted_history
			],
			'messages_to_ai' => [
				'count' => count($messages_to_send),
				'messages' => $messages_to_send
			],
			'request_params' => $request_params,
			'timestamp' => current_time('mysql')
		];
	}

	/**
	 * Основной метод для чата (для использования другими плагинами)
	 */
	public function chat_completion($params = [])
	{
		return $this->get_ai_client()->chat_completion($params);
	}

// includes/class-main.php - добавить в класс RDS_AIE_Main:

	/**
	 * Создание ассистента программно
	 *
	 * @param array $data Данные ассистента
	 * @return int|WP_Error ID созданного ассистента или ошибка
	 */
	public function create_assistant($data)
	{
		$defaults = [
			'name' => '',
			'system_prompt' => '',
			'default_model_id' => null,
			'max_tokens' => 1000,
			'temperature' => 0.7,
			'history_enabled' => true,
			'history_messages_count' => 10,
			'knowledge_base_enabled' => false
		];

		$data = wp_parse_args($data, $defaults);

		// Валидация
		if (empty($data['name'])) {
			return new WP_Error('invalid_name', __('Assistant name is required.', 'rds-ai-engine'));
		}

		if (empty($data['system_prompt'])) {
			return new WP_Error('invalid_prompt', __('System prompt is required.', 'rds-ai-engine'));
		}

		// Если не указана модель, используем модель по умолчанию
		if (empty($data['default_model_id'])) {
			$default_model = $this->get_model_manager()->get_default_model();
			if ($default_model) {
				$data['default_model_id'] = $default_model->id;
			}
		}

		try {
			$assistant_manager = $this->get_assistant_manager();
			$assistant_id = $assistant_manager->save($data);

			if (!$assistant_id) {
				return new WP_Error('save_failed', __('Failed to save assistant.', 'rds-ai-engine'));
			}

			// Действие после создания ассистента
			do_action('rds_aie_assistant_created', $assistant_id, $data);

			return $assistant_id;
		} catch (Exception $e) {
			return new WP_Error('exception', $e->getMessage());
		}
	}

	/**
	 * Получение ассистента по ID
	 *
	 * @param int $assistant_id ID ассистента
	 * @return object|WP_Error Объект ассистента или ошибка
	 */
	public function get_assistant($assistant_id)
	{
		try {
			$assistant = $this->get_assistant_manager()->get($assistant_id);

			if (!$assistant) {
				return new WP_Error('not_found', __('Assistant not found.', 'rds-ai-engine'));
			}

			return $assistant;
		} catch (Exception $e) {
			return new WP_Error('exception', $e->getMessage());
		}
	}

	/**
	 * Обновление ассистента
	 *
	 * @param int $assistant_id ID ассистента
	 * @param array $data Данные для обновления
	 * @return bool|WP_Error Успех или ошибка
	 */
	public function update_assistant($assistant_id, $data)
	{
		try {
			$assistant_manager = $this->get_assistant_manager();

			// Проверяем существование ассистента
			$existing = $assistant_manager->get($assistant_id);
			if (!$existing) {
				return new WP_Error('not_found', __('Assistant not found.', 'rds-ai-engine'));
			}

			$data['id'] = $assistant_id;
			$result = $assistant_manager->save($data);

			if (!$result) {
				return new WP_Error('update_failed', __('Failed to update assistant.', 'rds-ai-engine'));
			}

			// Действие после обновления ассистента
			do_action('rds_aie_assistant_updated', $assistant_id, $data);

			return true;
		} catch (Exception $e) {
			return new WP_Error('exception', $e->getMessage());
		}
	}

	/**
	 * Удаление ассистента
	 *
	 * @param int $assistant_id ID ассистента
	 * @return bool|WP_Error Успех или ошибка
	 */
	public function delete_assistant($assistant_id)
	{
		try {
			$assistant_manager = $this->get_assistant_manager();
			$result = $assistant_manager->delete($assistant_id);

			if (!$result) {
				return new WP_Error('delete_failed', __('Failed to delete assistant.', 'rds-ai-engine'));
			}

			// Действие после удаления ассистента
			do_action('rds_aie_assistant_deleted', $assistant_id);

			return true;
		} catch (Exception $e) {
			return new WP_Error('exception', $e->getMessage());
		}
	}

	/**
	 * Поиск ассистентов по имени
	 *
	 * @param string $search Строка поиска
	 * @return array|WP_Error Массив ассистентов или ошибка
	 */
	public function search_assistants($search)
	{
		try {
			$all_assistants = $this->get_assistant_manager()->get_all();
			$results = [];

			foreach ($all_assistants as $assistant) {
				if (stripos($assistant->name, $search) !== false) {
					$results[] = $assistant;
				}
			}

			return $results;
		} catch (Exception $e) {
			return new WP_Error('exception', $e->getMessage());
		}
	}

	/**
	 * Получение всех ассистентов
	 *
	 * @return array|WP_Error Массив ассистентов или ошибка
	 */
	public function get_all_assistants()
	{
		try {
			return $this->get_assistant_manager()->get_all();
		} catch (Exception $e) {
			return new WP_Error('exception', $e->getMessage());
		}
	}

	/**
	 * Создание или получение существующего ассистента по имени
	 * (удобно для плагинов, которым нужен гарантированно уникальный ассистент)
	 *
	 * @param string $name Уникальное имя ассистента
	 * @param array $data Данные ассистента (используются только при создании)
	 * @return int|WP_Error ID ассистента или ошибка
	 */
	public function get_or_create_assistant($name, $data = [])
	{
		// Ищем существующего ассистента с таким именем
		$assistants = $this->search_assistants($name);

		if (!is_wp_error($assistants) && !empty($assistants)) {
			foreach ($assistants as $assistant) {
				if ($assistant->name === $name) {
					return $assistant->id;
				}
			}
		}

		// Если не найден, создаем нового
		$data['name'] = $name;
		return $this->create_assistant($data);
	}

	/**
	 * Активация плагина
	 */
	public static function activate()
	{
		// Загружаем класс DB напрямую
		require_once RDS_AIE_PLUGIN_DIR . 'includes/class-db.php';

		$db = new RDS_AIE_DB();
		$db->create_tables();

		// Добавляем опции по умолчанию
		add_option('rds_aie_version', RDS_AIE_VERSION);
		add_option('rds_aie_default_settings', [
			'max_tokens' => 1000,
			'temperature' => 0.7,
			'history_enabled' => true,
			'history_messages_count' => 10
		]);

		// Настройки истории по умолчанию
		add_option('rds_aie_history_settings', [
			'history_retention_days' => 7,
			'cleanup_enabled' => true
		]);
	}

	/**
	 * Деактивация плагина
	 */
	public static function deactivate()
	{
		// Очистка кеша, остановка крона и т.д.
		wp_clear_scheduled_hook('rds_aie_daily_cleanup');
	}

	/**
	 * Удаление плагина
	 */
	public static function uninstall()
	{
		// Загружаем класс DB напрямую
		require_once RDS_AIE_PLUGIN_DIR . 'includes/class-db.php';

		// Удаление таблиц БД
		$db = new RDS_AIE_DB();
		$db->drop_tables();

		// Удаление опций
		delete_option('rds_aie_version');
		delete_option('rds_aie_default_settings');
		delete_option('rds_aie_history_settings');
	}
}

```

## includes/class-model-manager.php

```php
<?php

/**
 * Класс для управления моделями (креденшиалами)
 */

class RDS_AIE_Model_Manager
{

	private $db;

	public function __construct($db)
	{
		$this->db = $db;
	}

	/**
	 * Получение всех моделей
	 */
	public function get_all()
	{
		return $this->db->get_models();
	}

	/**
	 * Получение модели по ID
	 */
	public function get($id)
	{
		$model = $this->db->get_model($id);
		if ($model) {
			// Расшифровываем API ключ
			$model->api_key = $this->decrypt_api_key($model->api_key);
		}
		return $model;
	}

	/**
	 * Сохранение модели
	 */
	public function save($data)
	{
		// Валидация данных
		if (empty($data['name'])) {
			throw new Exception(__('Model name is required.', 'rds-ai-engine'));
		}

		if (empty($data['base_url'])) {
			throw new Exception(__('Base URL is required.', 'rds-ai-engine'));
		}

		if (empty($data['model_name'])) {
			throw new Exception(__('AI model name is required.', 'rds-ai-engine'));
		}

		if (empty($data['api_key'])) {
			throw new Exception(__('API key is required.', 'rds-ai-engine'));
		}

		// Шифрование API ключа
		$data['api_key'] = $this->encrypt_api_key($data['api_key']);

		// Если это модель по умолчанию, снимаем флаг с других
		if (!empty($data['is_default'])) {
			$this->unset_default_models();
		}

		return $this->db->save_model($data);
	}

	/**
	 * Удаление модели
	 */
	public function delete($id)
	{
		// Проверяем, не используется ли модель в ассистентах
		$assistants = $this->db->get_assistants();
		foreach ($assistants as $assistant) {
			if ($assistant->default_model_id == $id) {
				throw new Exception(
					__('Cannot delete model because it is used by one or more assistants.', 'rds-ai-engine')
				);
			}
		}

		return $this->db->delete_model($id);
	}

	/**
	 * Шифрование API ключа
	 */
	private function encrypt_api_key($api_key)
	{
		if (empty($api_key)) {
			return '';
		}

		// Используем встроенные функции WordPress для шифрования
		$key = wp_salt('auth');
		$iv = openssl_random_pseudo_bytes(openssl_cipher_iv_length('aes-256-cbc'));
		$encrypted = openssl_encrypt($api_key, 'aes-256-cbc', $key, 0, $iv);

		return base64_encode($iv . $encrypted);
	}

	/**
	 * Расшифровка API ключа
	 */
	private function decrypt_api_key($encrypted_key)
	{
		if (empty($encrypted_key)) {
			return '';
		}

		$data = base64_decode($encrypted_key);
		$iv_length = openssl_cipher_iv_length('aes-256-cbc');
		$iv = substr($data, 0, $iv_length);
		$encrypted = substr($data, $iv_length);

		$key = wp_salt('auth');
		return openssl_decrypt($encrypted, 'aes-256-cbc', $key, 0, $iv);
	}

	/**
	 * Снятие флага "по умолчанию" со всех моделей
	 */
	private function unset_default_models()
	{
		global $wpdb;
		$table_name = $wpdb->prefix . 'rds_aie_models';
		$wpdb->query("UPDATE {$table_name} SET is_default = 0 WHERE is_default = 1");
	}

	/**
	 * Получение модели по умолчанию
	 */
	public function get_default_model()
	{
		global $wpdb;
		$table_name = $wpdb->prefix . 'rds_aie_models';

		$model = $wpdb->get_row("SELECT * FROM {$table_name} WHERE is_default = 1 LIMIT 1");

		if ($model) {
			$model->api_key = $this->decrypt_api_key($model->api_key);
		}

		return $model;
	}
}

```

## uninstall.php

```php
<?php

/**
 * Удаление плагина RDS AI Engine
 */

// Если файл вызывается напрямую, прерываем выполнение
if (!defined('WP_UNINSTALL_PLUGIN')) {
	exit;
}

// Удаление таблиц БД
global $wpdb;
$table_prefix = $wpdb->prefix . 'rds_aie_';
$tables = [
	'assistants',
	'models'
];

foreach ($tables as $table) {
	$wpdb->query("DROP TABLE IF EXISTS {$table_prefix}{$table}");
}

// Удаление опций
delete_option('rds_aie_version');
delete_option('rds_aie_default_settings');

// Удаление кеша
wp_cache_flush();

```
